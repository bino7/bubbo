<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="shared-styles.html">
<dom-module id="my-peer">

  <template>

    <style is="custom-style" include="shared-styles">
      .page {
        width: 100%;
      }

      app-header {
        color: #fff;
        background-color: var(--app-primary-color);;
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .control1 {
        position: absolute;
        width: 100%;
        bottom: 0px;
        margin-bottom: 16px;
      }

      .input-container {
        @apply(--layout-horizontal);
        overflow-y: auto;
      }

      .input {
        @apply(--layout-flex);
        --paper-input-container: {
        };
        --paper-input-container-focus-color: rgba(66, 133, 244, 0);
        --paper-input-container-underline: {
          display: none
        };
        --paper-input-container-label-floating: {
          display: none;
        };
        font-size: 1.2em;
        border: none;
        display: block;

        border: 0;
        border-radius: 0;
        box-shadow: none;
        font-size: 14px;
        padding: 8px 10px;

        word-wrap: break-word;
        word-break: break-all;

        outline: 0px solid transparent;
      }

      .button-container {
        @apply(--layout-horizontal);
        @apply(--layout-end);
      }

      .button-container paper-icon-button {
        @apply(--layout-center-center);
        margin-right: 8px;
      }

      .toolbar {
        background-color: #fff;
      }

      .emoji {
        width: 24px;
        height: 24px;
        margin-left: 2px;
      }

      .overlay {
        @apply(--layout-fit);
        background-color: transparent;
      }

      .console {
        /*@apply(--layout-horizontal);
        position:relative;
        float:left;
        bottom: 0px;
        margin:0 16px 16px 16px;
        width:100%;*/
      }

      .control {
        width: 100%;
        bottom: 32px;
        margin-left: 32px;
        position: absolute;
        display: block;
        z-index: 3;
      }

      .control-bt {
        margin-top: 16px;
        background-color: #aab8c2;
        z-index: 3;
      }

      .control-bt:hover {
        background-color: var(--app-primary-color);

      }

      .call:hover {
        background-color: crimson;
      }

      .videos {
        font-size: 0;
        height: 100%;
        width: 100%;
        display: block;
        pointer-events: none;
        position: relative;
        transition: all 1s;
        z-index: 1;
      }

      .local-video {
        opacity: 1;
        z-index: 2;
        right: 32px;
        bottom: 16px;
        max-height: 17%;
        max-width: 17%;
        position: absolute;
        transition: opacity 1s;
        object-fit: contain;
        float: right;
        border: 1px solid gray;
      }

      .remote-video {
        object-fit: fill;
        display: block;
        position: relative;
        transform: rotateY(180deg);
        transition: opacity 1s;
        width: 100%;
        /*padding-bottom: 500%;*/
      }

      .video-container {
        width: 100%;
        position: relative;
        padding-bottom: 56.25%;
        padding-top: 0;
        height: 0;
        overflow: hidden;
      }

      .video-container iframe,
      .video-container object,
      .video-container embed {
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        /*width: 100%;
        height: 100%;*/
      }

      .hidden{
        display:none;
      }

    </style>
    <paper-dialog id="msgDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
      <h3 class="msg">[[msg]]</h3>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>Accept</paper-button>
      </div>
    </paper-dialog>
    <app-header-layout class="page">
      <template is="dom-if" if="[[expanded]]">
        <div class="overlay" on-tap="unexpand"></div>
      </template>
      <app-header>
        <app-toolbar>
          <div main-title>[[remote]]</div>
          <paper-icon-button icon="av:videocam" on-tap="_videoChat"></paper-icon-button>
        </app-toolbar>
      </app-header>

      <div class="videos">
        <div class="video-container">
          <video id="remote" class="remote-video"></video>
        </div>
        <video id="local" class="local-video hidden" autoplay muted></video>
      </div>

      <div class="console">
        <div id="control" class="control hidden">
          <paper-fab class="control-bt call" mini icon="communication:call-end" on-tap="hangUp"></paper-fab>
        </div>
      </div>
      <!--<div class="container content-container control">
        <template is="dom-if" if="[[expanded]]">
          <div class="pickers">
            <emoji-picker on-select-emoji="addEmoji"></emoji-picker>
          </div>
          <paper-toolbar class="toolbar">
            <div class="button-container">
              <paper-icon-button icon="default:face" on-tap="face" class="dropdown-trigger"></paper-icon-button>
              <paper-icon-button icon="image:photo-camera" on-tap="photo"></paper-icon-button>
              <paper-icon-button icon="editor:attach-file" on-tap="moreAction"></paper-icon-button>
            </div>
          </paper-toolbar>
        </template>
        <div class="container input-container">
          <div id="input" class="input" contenteditable on-tap="expand" on-paste="onPaste"></div>
          <div class="button-container">
            <paper-icon-button class="icon" icon="default:send" on-tap="send"></paper-icon-button>
          </div>
        </div>
      </div>-->
    </app-header-layout>
  </template>

  <script>

    Peer = Polymer({

      is: 'my-peer',

      properties: {
        peer: {
          type: Object
        },
        server: {
          type: Server,
          reflectToAttribute: true
        },
        uuid: {
          type: String,
          reflectToAttribute: true
        },
        remote: {
          type: String,
          reflectToAttribute: true
        },
        expanded: {
          type: Boolean,
          value: false
        },
        msg: {
          type: String
        },
        status: {
          type: String,
          value: 'notConnected', /*connected,connecting,notConnected*/
          observer: '_statusChanged'
        },
        stream: {
          type: Object
        },
        hangUp:{
          type:Boolean,
          value:false
        }
      },

      observers: [],

      factoryImpl: function (remote) {
        this.remote = remote;
      },

      ready: function () {
        var self = this;
        this.initPeer(false);
        this.server.addEventListener('peer-' + this.remote, function (e) {
          var event = e.detail;
          switch (event.Type) {
            case 'signal':
              self.peer.signal(event.Detail['data']);
              break;
          }
        });
        /**/
      },

      expand: function () {
        this.expanded = true;
      },

      unexpand: function () {
        this.expanded = false;
      },

      addEmoji: function (e) {
        var emoji = e.detail;
        if (emoji && emoji.base64) {
          var input = Polymer.dom(this.$.input);
          input.node.innerHTML += '<img class="emoji" src=' + emoji.base64 + '>';
        }
      },

      onPaste: function (e) {
        var text = e.clipboardData.getData('text');
        if (text) {
          e.clipboardData.clearData();
          e.clipboardData.setData('text', text);
        } else {
          e.preventDefault();
        }
        e.clipboardData.clearData();
        console.log(e, text);
      },

      onMessage: function (e) {

      },

      _videoChat: function () {
        var from = this.uuid;
        var to = this.remote;
        var event = new MyEvent('invitation', {
          'from': from,
          'to': to,
          'type': 'videoChat'
        });
        var self = this;
        this.server.send(event).then(function (event) {
          if (event.Type == 'invitation') {
            var reply = event.Detail.reply;
            if (reply) {
              if (reply == 'accept') {
                self.initPeer(true);
              } else if (reply == 'refuse') {
                var reason = to + ' has refused your video chat invitaion';
                if (event.Detail.reason) {
                  reason = ',' + event.Detail.reason;
                }
                self.msg = reason;
                self.$.msgDialog.open();
              }
            }

          }
        }).catch(function (event) {

        });
      },
      send: function (event) {
        if (this.peer.status != 'connected') {
          this.connect(event);
        }
      },

      initPeer: function (initiator) {
        var self = this;
        var SimplePeer = require('simple-peer');
        navigator.getUserMedia({video: true, audio: true}, function (stream) {
          var video = self.$.local;
          video.src = window.URL.createObjectURL(stream);
          video.play();

          var peer = new SimplePeer({initiator: initiator, stream: stream});
          self.peer = peer;

          peer.on('signal', function (data) {
            var event = new MyEvent('signal', {
              'from': self.uuid,
              'to': self.remote,
              'data': data
            }, 'peer-' + self.uuid);
            self.server.send(event);
          });

          peer.on('stream', function (stream) {
            console.log('on stream');
            var video = self.$.remote;
            video.src = window.URL.createObjectURL(stream);
            video.play();
          });

          peer.on('connect', function () {
            console.log('peer connected');
            self.status = 'connected';
          });

          peer.on('close', function () {
            console.log('peer closed');
            self.status = 'notConnected';
            self.initPeer(false);
            if(!self.hangUp){
              self.msg = 'Hang up';
              self.$.msgDialog.open();
            }

          });

          peer.on('error', function (err) {
            console.log('peer error', err);
            self.initPeer();
          });

          peer.on('data', self.onData);
        }, function () {
        });


      },

      onData: function (data) {
        var event = EventFromJSON(JSON.parse(data));
      },

      _computeHidden: function (status) {
        return status != 'connected';
      },

      _statusChanged:function(status){
        this.toggleClass('hidden',status!='connected', this.$.control);
        this.toggleClass('hidden',status!='connected', this.$.local);
      },

      hangUp:function(){
        this.hangUp=true;
        this.peer.destroy();
      }

    });

  </script>

</dom-module>